<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预测结果查看器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/viewer.css') }}">
</head>
<body>
    <div class="viewer-container">
        <header>
            <a href="/" class="back-btn">← 返回</a>
            <h1>预测结果查看器</h1>
        </header>
        
        <div class="viewer-main">
            <div class="image-container">
                <div class="image-wrapper" id="image-wrapper">
                    <img id="main-image" src="" alt="" class="zoomable">
                </div>
            </div>
            
            <div class="info-panel">
                <div class="image-info">
                    <h3 id="image-name"></h3>
                </div>
                
                <div class="legend-section">
                    <h4>模型说明</h4>
                    <div id="legend" class="legend"></div>
                </div>
                
                <div class="detections-section">
                    <h4>检测结果</h4>
                    <div id="detections" class="detections-list"></div>
                </div>
            </div>
        </div>
        
        <div class="navigation">
            <span id="image-counter" class="counter"></span>
            <div class="navigation-hint">使用 ← → 或 A D 键切换图片</div>
        </div>
    </div>
    
    <script>
        const resultId = '{{ result_id }}';
        let currentData = null;
        let imageList = [];
        let currentIndex = 0;
        let zoomLevel = 1;
        
        // Load results
        fetch(`/api/results/${resultId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('加载失败: ' + data.error);
                    return;
                }
                currentData = data;
                imageList = Object.keys(data.predictions);
                if (imageList.length > 0) {
                    currentIndex = 0;
                    updateViewer();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载失败: ' + error.message);
            });
        
        function updateViewer() {
            if (!currentData || imageList.length === 0) return;
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            // Update image
            const mainImage = document.getElementById('main-image');
            mainImage.src = pred.image;
            mainImage.onload = () => {
                zoomLevel = 1;
                updateZoom();
            };
            document.getElementById('image-name').textContent = imgName;
            
            // Update counter
            document.getElementById('image-counter').textContent = 
                `${currentIndex + 1} / ${imageList.length}`;
            
            // Update legend
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            if (currentData.model_infos) {
                currentData.model_infos.forEach((model, idx) => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    const styleDesc = model.style_desc || '实线';
                    const styleClass = `line-style-${model.line_style || 'solid'}`;
                    legendItem.innerHTML = `
                        <div class="legend-line-style ${styleClass}"></div>
                        <span><strong>${model.short_name || model.name}</strong> - ${styleDesc} (${model.type}${model.sub_type ? ' - ' + model.sub_type : ''})</span>
                    `;
                    legend.appendChild(legendItem);
                });
            }
            
            // Update label colors legend (only once, remove old one first)
            const legendSection = document.querySelector('.legend-section');
            const existingLabelLegend = legendSection.querySelector('.label-legend');
            if (existingLabelLegend) {
                existingLabelLegend.remove();
            }
            
            if (currentData.label_colors) {
                const labelLegend = document.createElement('div');
                labelLegend.className = 'label-legend';
                labelLegend.innerHTML = '<h4>标签颜色</h4>';
                const labelList = document.createElement('div');
                labelList.className = 'label-list';
                Object.entries(currentData.label_colors).forEach(([label, color]) => {
                    const labelItem = document.createElement('div');
                    labelItem.className = 'label-item';
                    labelItem.innerHTML = `
                        <div class="legend-color" style="background-color: rgb(${color.join(',')})"></div>
                        <span>${label}</span>
                    `;
                    labelList.appendChild(labelItem);
                });
                labelLegend.appendChild(labelList);
                if (legendSection) {
                    legendSection.appendChild(labelLegend);
                }
            }
            
            // Update detections
            const detectionsDiv = document.getElementById('detections');
            detectionsDiv.innerHTML = '';
            
            if (pred.predictions && pred.predictions.length > 0) {
                pred.predictions.forEach(predGroup => {
                    const modelSection = document.createElement('div');
                    modelSection.className = 'model-section';
                    
                    const modelHeader = document.createElement('div');
                    modelHeader.className = 'model-header';
                    const styleClass = `line-style-${predGroup.line_style || 'solid'}`;
                    const styleDesc = {
                        'solid': '实线',
                        'dashed': '虚线',
                        'dotted': '点线',
                        'dashdot': '点划线'
                    }[predGroup.line_style || 'solid'] || '实线';
                    modelHeader.innerHTML = `
                        <div class="legend-line-style ${styleClass}"></div>
                        <strong>${predGroup.model_name}</strong>
                        <span style="font-size: 11px; color: #999; margin-left: 5px;">(${styleDesc})</span>
                        <span class="count-badge">${predGroup.bboxes.length} 个检测框</span>
                    `;
                    modelSection.appendChild(modelHeader);
                    
                    if (predGroup.bboxes.length > 0) {
                        const bboxList = document.createElement('div');
                        bboxList.className = 'bbox-list';
                        predGroup.bboxes.forEach((bboxInfo, idx) => {
                            const bboxItem = document.createElement('div');
                            bboxItem.className = 'bbox-item';
                            const labelColor = bboxInfo.color || [0, 0, 0];
                            bboxItem.innerHTML = `
                                <div class="legend-color" style="background-color: rgb(${labelColor.join(',')})"></div>
                                <span class="bbox-label">${bboxInfo.label}</span>
                                <span class="bbox-score">置信度: ${(bboxInfo.score * 100).toFixed(2)}%</span>
                                <span class="bbox-coords">位置: [${Math.round(bboxInfo.bbox[0])}, ${Math.round(bboxInfo.bbox[1])}, ${Math.round(bboxInfo.bbox[2])}, ${Math.round(bboxInfo.bbox[3])}]</span>
                            `;
                            bboxList.appendChild(bboxItem);
                        });
                        modelSection.appendChild(bboxList);
                    }
                    
                    detectionsDiv.appendChild(modelSection);
                });
            } else {
                detectionsDiv.innerHTML = '<p class="no-detections">未检测到任何目标</p>';
            }
        }
        
        function navigateImage(direction) {
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = imageList.length - 1;
            if (currentIndex >= imageList.length) currentIndex = 0;
            zoomLevel = 1;
            updateZoom();
            updateViewer();
        }
        
        function updateZoom() {
            const img = document.getElementById('main-image');
            img.style.transform = `scale(${zoomLevel})`;
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Navigation: Left/Right arrows or A/D keys
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                navigateImage(-1);
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                navigateImage(1);
            }
            
            // Zoom controls
            if (e.key === '+' || e.key === '=') {
                zoomLevel = Math.min(zoomLevel + 0.2, 5);
                updateZoom();
            }
            if (e.key === '-') {
                zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
                updateZoom();
            }
            if (e.key === '0') {
                zoomLevel = 1;
                updateZoom();
            }
        });
        
        // Mouse wheel zoom
        document.getElementById('image-wrapper').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoomLevel = Math.max(0.5, Math.min(5, zoomLevel + delta));
                updateZoom();
            }
        });
    </script>
</body>
</html>

