<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DetUnify Studio - 预测结果查看器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/viewer.css') }}">
</head>
<body>
    <div class="viewer-container">
        <header>
            <a href="/" class="back-btn">← 返回</a>
            <h1>预测结果查看器</h1>
            <div id="image-name-header" class="image-name-header"></div>
            <button id="export-btn" class="export-btn">导出结果</button>
        </header>
        
        <div class="viewer-main">
            <div class="image-container">
                <div class="image-wrapper" id="image-wrapper">
                    <img id="main-image" src="" alt="" class="zoomable">
                </div>
            </div>
            
            <div class="info-panel">
                <div class="image-notes-section">
                    <h4>图片备注</h4>
                    <div class="status-badges" id="status-badges">
                        <span class="status-badge" id="status-false-positive" style="display: none;">误检</span>
                        <span class="status-badge" id="status-missed" style="display: none;">漏检</span>
                        <span class="status-badge" id="status-low-confidence" style="display: none;">低置信度</span>
                    </div>
                    <div id="status-labels-info" class="status-labels-info" style="display: none; margin-bottom: 8px; font-size: 10px; color: #666; line-height: 1.4;"></div>
                    <textarea id="image-notes" class="notes-textarea" placeholder="输入图片备注..."></textarea>
                    <div class="shortcuts-hint">
                        快捷键: F=误检, M=漏检, L=低置信度
                    </div>
                </div>
                
                <div class="detections-section">
                    <h4>检测结果</h4>
                    <div id="detections" class="detections-list"></div>
                </div>
                
                <div class="details-toggle">
                    <button id="toggle-details" class="toggle-btn">显示详细信息 ▼</button>
                </div>
                
                <div id="details-panel" class="details-panel" style="display: none;">
                    <div class="defect-types-section">
                        <h4>缺陷类型</h4>
                        <div id="defect-types" class="defect-types-list"></div>
                    </div>
                    
                    <div class="legend-section">
                        <h4>模型说明</h4>
                        <div id="legend" class="legend"></div>
                    </div>
                    
                    <div class="label-colors-section">
                        <h4>标签颜色</h4>
                        <div id="label-colors" class="label-list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="navigation">
            <span id="image-counter" class="counter"></span>
            <div class="navigation-hint">使用 ← → 或 A D 键切换图片 | F=误检 M=漏检 L=低置信度</div>
        </div>
    </div>
    
    <!-- 标签选择模态窗口 -->
    <div id="label-selector-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="label-selector-title">选择标签</h3>
                <button class="modal-close" onclick="closeLabelSelector()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="label-selector-description">请选择标签（可多选）：</p>
                <div id="label-checkboxes" class="label-checkboxes"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeLabelSelector()">取消</button>
                <button onclick="confirmLabelSelection()" class="btn-primary">确认</button>
            </div>
        </div>
    </div>
    
    <!-- 导出模态窗口 -->
    <div id="export-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导出结果</h3>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="export-filename">文件名（不含扩展名）:</label>
                    <input type="text" id="export-filename" class="form-input" placeholder="预测结果报告" value="">
                </div>
                <div class="form-group">
                    <label for="export-description">说明信息:</label>
                    <textarea id="export-description" class="form-textarea" placeholder="请输入报告说明信息（可选）" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label>导出选项:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-originals" checked>
                            <span>导出原图</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-models">
                            <span>导出模型文件</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeExportModal()">取消</button>
                <button onclick="confirmExport()" class="btn-primary">确认导出</button>
            </div>
        </div>
    </div>
    
    <!-- 导出进度条模态窗口 -->
    <div id="export-progress-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>导出进度</h3>
            </div>
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div id="export-progress-bar" class="progress-bar"></div>
                    </div>
                    <div id="export-progress-text" class="progress-text">准备中...</div>
                    <div id="export-progress-detail" class="progress-detail"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const resultId = '{{ result_id }}';
        let currentData = null;
        let imageList = [];
        let currentIndex = 0;
        let zoomLevel = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let imageOffset = { x: 0, y: 0 };
        
        // Load results
        fetch(`/api/results/${resultId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('加载失败: ' + data.error);
                    return;
                }
                currentData = data;
                imageList = Object.keys(data.predictions);
                if (imageList.length > 0) {
                    currentIndex = 0;
                    updateViewer();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载失败: ' + error.message);
            });
        
        function updateViewer() {
            if (!currentData || imageList.length === 0) return;
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            // Update image
            const mainImage = document.getElementById('main-image');
            mainImage.src = pred.image;
            mainImage.onload = () => {
                zoomLevel = 1;
                resetImagePosition();
            };
            // Update image name in header
            document.getElementById('image-name-header').textContent = imgName;
            
            // Update counter
            document.getElementById('image-counter').textContent = 
                `${currentIndex + 1} / ${imageList.length}`;
            
            // Update notes and status
            const notesTextarea = document.getElementById('image-notes');
            const statusBadges = {
                falsePositive: document.getElementById('status-false-positive'),
                missed: document.getElementById('status-missed')
            };
            
            // Load saved notes and statuses (支持多状态)
            const imageNotes = pred.notes || '';
            notesTextarea.value = imageNotes;
            
            // 获取状态列表（支持新的statuses数组或旧的status字段）
            let imageStatuses = pred.statuses || [];
            if (!imageStatuses.length && pred.status) {
                imageStatuses = [pred.status];
            }
            
            // 检查是否有低置信度（最大置信度 < 0.5）
            let maxScore = 0.0;
            if (pred.predictions) {
                pred.predictions.forEach(predGroup => {
                    predGroup.bboxes.forEach(bbox => {
                        if (bbox.score > maxScore) {
                            maxScore = bbox.score;
                        }
                    });
                });
            }
            if (maxScore < 0.5 && maxScore > 0) {
                if (!imageStatuses.includes('low_confidence')) {
                    imageStatuses.push('low_confidence');
                }
            }
            
            // Update status badges（支持多状态）
            statusBadges.falsePositive.style.display = imageStatuses.includes('false_positive') ? 'inline-block' : 'none';
            statusBadges.missed.style.display = imageStatuses.includes('missed') ? 'inline-block' : 'none';
            
            // 添加低置信度徽章显示
            const lowConfidenceBadge = document.getElementById('status-low-confidence');
            if (lowConfidenceBadge) {
                lowConfidenceBadge.style.display = imageStatuses.includes('low_confidence') ? 'inline-block' : 'none';
            }
            
            // 显示状态对应的类别信息
            const statusLabelsInfo = document.getElementById('status-labels-info');
            if (statusLabelsInfo) {
                let labelsInfoHtml = [];
                
                const falsePositiveLabels = pred.false_positive_labels || [];
                if (falsePositiveLabels.length > 0) {
                    labelsInfoHtml.push(`<span style="color: #e74c3c;">误检: ${falsePositiveLabels.join(', ')}</span>`);
                }
                
                const missedLabels = pred.missed_labels || [];
                if (missedLabels.length > 0) {
                    labelsInfoHtml.push(`<span style="color: #f39c12;">漏检: ${missedLabels.join(', ')}</span>`);
                }
                
                const lowConfidenceLabels = pred.low_confidence_labels || [];
                if (lowConfidenceLabels.length > 0) {
                    labelsInfoHtml.push(`<span style="color: #1976d2;">低置信度: ${lowConfidenceLabels.join(', ')}</span>`);
                }
                
                if (labelsInfoHtml.length > 0) {
                    statusLabelsInfo.innerHTML = labelsInfoHtml.join(' | ');
                    statusLabelsInfo.style.display = 'block';
                } else {
                    statusLabelsInfo.style.display = 'none';
                }
            }
            
            // Update defect types (simplified - only labels)
            const defectTypesDiv = document.getElementById('defect-types');
            defectTypesDiv.innerHTML = '';
            
            if (pred.predictions && pred.predictions.length > 0) {
                const allLabels = new Set();
                pred.predictions.forEach(predGroup => {
                    predGroup.bboxes.forEach(bbox => {
                        allLabels.add(bbox.label);
                    });
                });
                
                Array.from(allLabels).sort().forEach(label => {
                    const labelItem = document.createElement('div');
                    labelItem.className = 'defect-type-item';
                    const labelColor = currentData.label_colors && currentData.label_colors[label] 
                        ? currentData.label_colors[label] 
                        : [128, 128, 128];
                    labelItem.innerHTML = `
                        <div class="legend-color" style="background-color: rgb(${labelColor.join(',')})"></div>
                        <span>${label}</span>
                    `;
                    defectTypesDiv.appendChild(labelItem);
                });
            }
            
            // Update legend (only in details panel)
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            if (currentData.model_infos) {
                currentData.model_infos.forEach((model, idx) => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    const styleDesc = model.style_desc || '实线';
                    const styleClass = `line-style-${model.line_style || 'solid'}`;
                    legendItem.innerHTML = `
                        <div class="legend-line-style ${styleClass}"></div>
                        <span><strong>${model.short_name || model.name}</strong> - ${styleDesc} (${model.type}${model.sub_type ? ' - ' + model.sub_type : ''})</span>
                    `;
                    legend.appendChild(legendItem);
                });
            }
            
            // Update label colors (only in details panel)
            const labelColorsDiv = document.getElementById('label-colors');
            labelColorsDiv.innerHTML = '';
            if (currentData.label_colors) {
                Object.entries(currentData.label_colors).forEach(([label, color]) => {
                    const labelItem = document.createElement('div');
                    labelItem.className = 'label-item';
                    labelItem.innerHTML = `
                        <div class="legend-color" style="background-color: rgb(${color.join(',')})"></div>
                        <span>${label}</span>
                    `;
                    labelColorsDiv.appendChild(labelItem);
                });
            }
            
            // Update detections (simplified, one line per detection)
            const detectionsDiv = document.getElementById('detections');
            detectionsDiv.innerHTML = '';
            
            if (pred.predictions && pred.predictions.length > 0) {
                // Collect all bboxes from all models
                const allBboxes = [];
                pred.predictions.forEach(predGroup => {
                    predGroup.bboxes.forEach(bboxInfo => {
                        allBboxes.push({
                            ...bboxInfo,
                            line_style: predGroup.line_style || 'solid'
                        });
                    });
                });
                
                // Sort by score (descending) or label
                allBboxes.sort((a, b) => {
                    if (a.label !== b.label) {
                        return a.label.localeCompare(b.label);
                    }
                    return b.score - a.score;
                });
                
                // Display each bbox in one compact line (clickable for false positive label selection)
                allBboxes.forEach((bboxInfo, index) => {
                    const bboxItem = document.createElement('div');
                    bboxItem.className = 'bbox-item-compact';
                    bboxItem.style.cursor = 'pointer';
                    bboxItem.title = '点击选择误检标签';
                    const labelColor = bboxInfo.color || [128, 128, 128];
                    const styleClass = `line-style-${bboxInfo.line_style || 'solid'}`;
                    
                    // Format: [框] <标签名> (置信度分数)
                    bboxItem.innerHTML = `
                        <div class="bbox-indicator">
                            <div class="legend-line-style-compact ${styleClass}" style="border-color: rgb(${labelColor.join(',')}); color: rgb(${labelColor.join(',')});"></div>
                        </div>
                        <span class="bbox-label-compact">${bboxInfo.label}</span>
                        <span class="bbox-score-compact">(${(bboxInfo.score * 100).toFixed(1)}%)</span>
                    `;
                    
                    // 添加点击事件：弹出标签选择窗口
                    bboxItem.addEventListener('click', () => {
                        openLabelSelector(bboxInfo, index);
                    });
                    
                    detectionsDiv.appendChild(bboxItem);
                });
            } else {
                detectionsDiv.innerHTML = '<p class="no-detections">未检测到任何目标</p>';
            }
        }
        
        function navigateImage(direction) {
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = imageList.length - 1;
            if (currentIndex >= imageList.length) currentIndex = 0;
            zoomLevel = 1;
            resetImagePosition();
            updateViewer();
        }
        
        function updateZoom() {
            const img = document.getElementById('main-image');
            img.style.transform = `translate(${imageOffset.x}px, ${imageOffset.y}px) scale(${zoomLevel})`;
        }
        
        // Image dragging functionality
        const mainImage = document.getElementById('main-image');
        const imageWrapper = document.getElementById('image-wrapper');
        
        mainImage.addEventListener('mousedown', (e) => {
            if (e.button === 0) { // Left mouse button
                isDragging = true;
                dragStart.x = e.clientX - imageOffset.x;
                dragStart.y = e.clientY - imageOffset.y;
                mainImage.style.cursor = 'grabbing';
                mainImage.style.transition = 'none'; // Disable transition during dragging
                e.preventDefault();
            }
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                imageOffset.x = e.clientX - dragStart.x;
                imageOffset.y = e.clientY - dragStart.y;
                updateZoom();
                e.preventDefault();
            }
        });
        
        document.addEventListener('mouseup', (e) => {
            if (e.button === 0) { // Left mouse button
                if (isDragging) {
                    isDragging = false;
                    mainImage.style.cursor = 'grab';
                    mainImage.style.transition = 'transform 0.1s'; // Re-enable transition
                }
            }
        });
        
        // Prevent context menu on right click during drag
        mainImage.addEventListener('contextmenu', (e) => {
            if (isDragging) {
                e.preventDefault();
            }
        });
        
        // Reset image offset when image changes or zoom resets
        function resetImagePosition() {
            imageOffset.x = 0;
            imageOffset.y = 0;
            updateZoom();
        }
        
        // Save notes and status (支持多状态)
        function saveImageNotes() {
            if (!currentData || imageList.length === 0) return;
            saveImageStatuses(); // 使用统一的状态保存函数
        }
        
        // Set image status (支持多状态)
        function setImageStatus(status) {
            if (!currentData || imageList.length === 0) return;
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            // 获取当前状态列表
            let statuses = pred.statuses || [];
            if (!statuses.length && pred.status) {
                statuses = [pred.status];
            }
            
            // Toggle status: 如果已存在则移除，否则添加
            const statusIndex = statuses.indexOf(status);
            if (statusIndex >= 0) {
                statuses.splice(statusIndex, 1);
            } else {
                statuses.push(status);
            }
            
            // 更新状态列表
            pred.statuses = statuses;
            
            // 向后兼容：更新旧的status字段
            pred.status = statuses.length > 0 ? statuses[0] : null;
            
            // 更新徽章显示
            const statusBadges = {
                falsePositive: document.getElementById('status-false-positive'),
                missed: document.getElementById('status-missed'),
                lowConfidence: document.getElementById('status-low-confidence')
            };
            
            if (statusBadges.falsePositive) {
                statusBadges.falsePositive.style.display = statuses.includes('false_positive') ? 'inline-block' : 'none';
            }
            if (statusBadges.missed) {
                statusBadges.missed.style.display = statuses.includes('missed') ? 'inline-block' : 'none';
            }
            if (statusBadges.lowConfidence) {
                statusBadges.lowConfidence.style.display = statuses.includes('low_confidence') ? 'inline-block' : 'none';
            }
            
            // 保存到服务器
            saveImageStatuses();
        }
        
        // 保存图片状态（支持多状态）
        function saveImageStatuses() {
            if (!currentData || imageList.length === 0) return;
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            const notesTextarea = document.getElementById('image-notes');
            
            const statuses = pred.statuses || [];
            const falsePositiveLabels = pred.false_positive_labels || [];
            const missedLabels = pred.missed_labels || [];
            const lowConfidenceLabels = pred.low_confidence_labels || [];
            
            fetch(`/api/results/${resultId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: imgName,
                    notes: notesTextarea.value.trim(),
                    statuses: statuses,
                    false_positive_labels: falsePositiveLabels,
                    missed_labels: missedLabels,
                    low_confidence_labels: lowConfidenceLabels
                })
            }).catch(error => {
                console.error('Error saving statuses:', error);
            });
        }
        
        // Auto-save notes when typing stops
        let notesSaveTimeout;
        document.getElementById('image-notes').addEventListener('input', () => {
            clearTimeout(notesSaveTimeout);
            notesSaveTimeout = setTimeout(saveImageNotes, 1000); // Save after 1 second of inactivity
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // But allow status shortcuts even in textarea
                if (e.key === 'f' || e.key === 'F' || e.key === 'm' || e.key === 'M' || e.key === 'l' || e.key === 'L') {
                    if (e.target.tagName === 'TEXTAREA') {
                        e.preventDefault();
                        if (e.key === 'f' || e.key === 'F') {
                            toggleStatusWithSmartMatch('false_positive');
                        } else if (e.key === 'm' || e.key === 'M') {
                            toggleStatusWithSmartMatch('missed');
                        } else if (e.key === 'l' || e.key === 'L') {
                            toggleStatusWithSmartMatch('low_confidence');
                        }
                    }
                }
                return;
            }
            
            // Status shortcuts: F = false positive (误检), M = missed (漏检), L = low confidence (低置信度)
            // 支持切换：第二次按取消状态
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                toggleStatusWithSmartMatch('false_positive');
                return;
            }
            if (e.key === 'm' || e.key === 'M') {
                e.preventDefault();
                toggleStatusWithSmartMatch('missed');
                return;
            }
            if (e.key === 'l' || e.key === 'L') {
                e.preventDefault();
                toggleStatusWithSmartMatch('low_confidence');
                return;
            }
            
            // Navigation: Left/Right arrows or A/D keys
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                navigateImage(-1);
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                navigateImage(1);
            }
            
            // Zoom controls
            if (e.key === '+' || e.key === '=') {
                zoomLevel = Math.min(zoomLevel + 0.2, 5);
                updateZoom();
            }
            if (e.key === '-') {
                zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
                updateZoom();
            }
            if (e.key === '0') {
                zoomLevel = 1;
                resetImagePosition();
            }
        });
        
        // Mouse wheel zoom
        document.getElementById('image-wrapper').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoomLevel = Math.max(0.5, Math.min(5, zoomLevel + delta));
                updateZoom();
            }
        });
        
        // Toggle details panel
        const toggleBtn = document.getElementById('toggle-details');
        const detailsPanel = document.getElementById('details-panel');
        let detailsExpanded = false;
        
        if (toggleBtn && detailsPanel) {
            toggleBtn.addEventListener('click', () => {
                detailsExpanded = !detailsExpanded;
                if (detailsExpanded) {
                    detailsPanel.style.display = 'block';
                    toggleBtn.textContent = '隐藏详细信息 ▲';
                } else {
                    detailsPanel.style.display = 'none';
                    toggleBtn.textContent = '显示详细信息 ▼';
                }
            });
        }
        
        // Export button handler
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                openExportModal();
            });
        }
        
        // Export modal functions
        function openExportModal() {
            const modal = document.getElementById('export-modal');
            const filenameInput = document.getElementById('export-filename');
            const descriptionInput = document.getElementById('export-description');
            
            // 设置默认文件名
            filenameInput.value = `预测结果_${resultId}`;
            descriptionInput.value = '';
            
            modal.style.display = 'flex';
            filenameInput.focus();
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        function showExportProgress() {
            const progressModal = document.getElementById('export-progress-modal');
            const progressBar = document.getElementById('export-progress-bar');
            const progressText = document.getElementById('export-progress-text');
            const progressDetail = document.getElementById('export-progress-detail');
            
            if (progressModal) {
                progressModal.style.display = 'flex';
                if (progressBar) {
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = '0%';
                }
                if (progressText) {
                    progressText.textContent = '准备导出...';
                }
                if (progressDetail) {
                    progressDetail.textContent = '';
                }
            }
        }
        
        function updateExportProgress(stage, detail, progress) {
            const progressBar = document.getElementById('export-progress-bar');
            const progressText = document.getElementById('export-progress-text');
            const progressDetail = document.getElementById('export-progress-detail');
            
            if (progressBar && progress !== undefined && progress !== null) {
                progressBar.style.width = progress + '%';
                progressBar.className = 'progress-bar';
            }
            
            if (progressText && stage) {
                progressText.textContent = stage;
            }
            
            if (progressDetail && detail) {
                progressDetail.textContent = detail;
            }
        }
        
        function hideExportProgress() {
            const progressModal = document.getElementById('export-progress-modal');
            if (progressModal) {
                progressModal.style.display = 'none';
            }
        }
        
        function confirmExport() {
            const filenameInput = document.getElementById('export-filename');
            const descriptionInput = document.getElementById('export-description');
            const exportOriginalsCheckbox = document.getElementById('export-originals');
            const exportModelsCheckbox = document.getElementById('export-models');
            const exportBtn = document.getElementById('export-btn');
            
            const filename = filenameInput.value.trim() || `预测结果_${resultId}`;
            const description = descriptionInput.value.trim();
            const exportOriginals = exportOriginalsCheckbox ? exportOriginalsCheckbox.checked : true;
            const exportModels = exportModelsCheckbox ? exportModelsCheckbox.checked : false;
            
            // 关闭模态窗口
            closeExportModal();
            
            // 禁用导出按钮
            exportBtn.disabled = true;
            exportBtn.textContent = '导出中...';
            
            // 构建导出 URL（包含参数）
            let exportUrl = `/api/export/${resultId}`;
            const params = new URLSearchParams();
            if (description) {
                params.append('description', description);
            }
            params.append('export_originals', exportOriginals ? '1' : '0');
            params.append('export_models', exportModels ? '1' : '0');
            if (params.toString()) {
                exportUrl += '?' + params.toString();
            }
            
            // 显示进度条
            showExportProgress();
            
            // 使用EventSource接收SSE进度事件
            const eventSource = new EventSource(exportUrl);
            let taskId = null;
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 更新进度
                    if (data.stage && data.detail !== undefined) {
                        updateExportProgress(data.stage, data.detail, data.progress);
                    }
                    
                    // 检查是否完成并包含task_id（必须同时有complete/ready和task_id才下载）
                    if ((data.complete || data.ready) && data.task_id) {
                        const taskId = data.task_id;
                        
                        // 关闭EventSource连接
                        eventSource.close();
                        
                        // 更新进度显示
                        updateExportProgress('正在下载文件...', '文件已生成，正在下载', 100);
                        
                        // 延迟一下再下载，确保文件完全写入磁盘
                        setTimeout(() => {
                            const downloadUrl = `/api/export/download/${taskId}`;
                            
                            // 使用fetch下载文件，确保能够正确触发下载
                            fetch(downloadUrl)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('下载失败: HTTP ' + response.status);
                                    }
                                    return response.blob();
                                })
                                .then(blob => {
                                    // 创建下载链接并触发下载
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `${filename}.zip`;
                                    a.style.display = 'none';
                                    document.body.appendChild(a);
                                    a.click();
                                    
                                    // 清理
                                    setTimeout(() => {
                                        window.URL.revokeObjectURL(url);
                                        document.body.removeChild(a);
                                    }, 100);
                                    
                                    // 关闭进度条
                                    setTimeout(() => {
                                        hideExportProgress();
                                        exportBtn.disabled = false;
                                        exportBtn.textContent = '导出结果';
                                    }, 500);
                                })
                                .catch(error => {
                                    console.error('下载错误:', error);
                                    hideExportProgress();
                                    alert('下载失败: ' + error.message);
                                    exportBtn.disabled = false;
                                    exportBtn.textContent = '导出结果';
                                });
                        }, 500);
                        
                        return; // 处理完成后直接返回，避免重复处理
                    }
                    
                    // 如果只有complete/ready但没有task_id，说明可能出错了
                    if ((data.complete || data.ready) && !data.task_id) {
                        console.warn('收到完成信号但缺少task_id:', data);
                        // 继续等待task_id，不关闭连接
                    }
                    
                    // 检查是否有错误
                    if (data.error) {
                        eventSource.close();
                        hideExportProgress();
                        alert('导出失败: ' + data.error);
                        exportBtn.disabled = false;
                        exportBtn.textContent = '导出结果';
                    }
                } catch (error) {
                    console.error('Error parsing SSE data:', error);
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE error:', error);
                eventSource.close();
                hideExportProgress();
                alert('导出失败: 连接错误');
                exportBtn.disabled = false;
                exportBtn.textContent = '导出结果';
            };
        }
        
        // 点击模态窗口外部关闭
        document.getElementById('export-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExportModal();
            }
        });
        
        // 标签选择模态窗口相关变量和函数
        let currentBboxForLabelSelection = null;
        let currentBboxIndex = -1;
        let currentStatusTypeForLabelSelection = null; // 'false_positive', 'missed', 'low_confidence', 或 null (用于检测框)
        
        // 智能切换状态：检查是否已存在，如果存在则取消；如果不存在则智能匹配或弹窗
        function toggleStatusWithSmartMatch(statusType) {
            if (!currentData || imageList.length === 0) return;
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            if (!pred.statuses) {
                pred.statuses = [];
            }
            
            // 检查状态是否已存在
            const statusIndex = pred.statuses.indexOf(statusType);
            if (statusIndex >= 0) {
                // 状态已存在，取消状态
                pred.statuses.splice(statusIndex, 1);
                
                // 清除对应的标签
                if (statusType === 'false_positive') {
                    pred.false_positive_labels = [];
                } else if (statusType === 'missed') {
                    pred.missed_labels = [];
                } else if (statusType === 'low_confidence') {
                    pred.low_confidence_labels = [];
                }
                
                // 更新显示和保存
                updateViewer();
                saveImageStatuses();
                return;
            }
            
            // 状态不存在，需要添加
            // 智能判断：检查所有框是否都是同一类别（仅对 F 和 L 有效）
            if (statusType === 'false_positive' || statusType === 'low_confidence') {
                const allLabels = new Set();
                if (pred.predictions && pred.predictions.length > 0) {
                    pred.predictions.forEach(predGroup => {
                        if (predGroup.bboxes && predGroup.bboxes.length > 0) {
                            predGroup.bboxes.forEach(bbox => {
                                allLabels.add(bbox.label);
                            });
                        }
                    });
                }
                
                // 如果只有一个类别且至少有一个检测框，自动匹配
                if (allLabels.size === 1 && allLabels.size > 0) {
                    const singleLabel = Array.from(allLabels)[0];
                    
                    // 添加状态和标签
                    pred.statuses.push(statusType);
                    if (statusType === 'false_positive') {
                        pred.false_positive_labels = [singleLabel];
                    } else if (statusType === 'low_confidence') {
                        pred.low_confidence_labels = [singleLabel];
                    }
                    
                    // 更新显示和保存
                    updateViewer();
                    saveImageStatuses();
                    return;
                }
            }
            
            // 多个类别、M 键或没有检测框，弹出选择窗口
            openLabelSelectorForStatus(statusType);
        }
        
        // 通用的标签选择函数，支持不同状态类型（用于快捷键）
        function openLabelSelectorForStatus(statusType) {
            // statusType: 'false_positive', 'missed', 'low_confidence'
            currentBboxForLabelSelection = null;
            currentBboxIndex = -1;
            currentStatusTypeForLabelSelection = statusType;
            
            // 获取所有可用标签
            const allLabels = new Set();
            
            // 对于漏检（missed），从所有类别标签中获取（因为漏检是指应该检测到但没检测到的）
            if (statusType === 'missed') {
                if (currentData && currentData.label_colors) {
                    Object.keys(currentData.label_colors).forEach(label => {
                        allLabels.add(label);
                    });
                }
            } else {
                // 对于误检和低置信度，只从当前图片的检测结果中获取
                if (currentData && currentData.predictions) {
                    const imgName = imageList[currentIndex];
                    const pred = currentData.predictions[imgName];
                    if (pred && pred.predictions) {
                        pred.predictions.forEach(predGroup => {
                            predGroup.bboxes.forEach(bbox => {
                                allLabels.add(bbox.label);
                            });
                        });
                    }
                }
            }
            
            // 获取当前已选择的标签（根据状态类型）
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            let existingLabels = [];
            let statusName = '';
            let description = '';
            
            if (statusType === 'false_positive') {
                existingLabels = pred.false_positive_labels || [];
                statusName = '误检';
                description = '请选择误检标签（可多选）：';
            } else if (statusType === 'missed') {
                existingLabels = pred.missed_labels || [];
                statusName = '漏检';
                description = '请选择漏检标签（可多选，包含所有类别）：';
            } else if (statusType === 'low_confidence') {
                existingLabels = pred.low_confidence_labels || [];
                statusName = '低置信度';
                description = '请选择低置信度标签（可多选）：';
            }
            
            // 更新模态窗口标题和描述
            document.getElementById('label-selector-title').textContent = `选择${statusName}标签`;
            document.getElementById('label-selector-description').textContent = description;
            
            // 生成标签复选框
            const checkboxesDiv = document.getElementById('label-checkboxes');
            checkboxesDiv.innerHTML = '';
            
            Array.from(allLabels).sort().forEach(label => {
                const labelItem = document.createElement('label');
                labelItem.style.display = 'flex';
                labelItem.style.alignItems = 'center';
                labelItem.style.marginBottom = '8px';
                labelItem.style.cursor = 'pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = label;
                checkbox.checked = existingLabels.includes(label);
                
                labelItem.appendChild(checkbox);
                labelItem.appendChild(document.createTextNode(` ${label}`));
                checkboxesDiv.appendChild(labelItem);
            });
            
            // 显示模态窗口
            document.getElementById('label-selector-modal').style.display = 'flex';
        }
        
        function openLabelSelector(bboxInfo, index) {
            currentBboxForLabelSelection = bboxInfo;
            currentBboxIndex = index;
            currentStatusTypeForLabelSelection = null;
            
            // 获取所有可用标签
            const allLabels = new Set();
            if (currentData && currentData.predictions) {
                const imgName = imageList[currentIndex];
                const pred = currentData.predictions[imgName];
                if (pred && pred.predictions) {
                    pred.predictions.forEach(predGroup => {
                        predGroup.bboxes.forEach(bbox => {
                            allLabels.add(bbox.label);
                        });
                    });
                }
            }
            
            // 获取当前已选择的误检标签（如果有）
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            const existingFalsePositiveLabels = pred.false_positive_labels || [];
            
            // 更新模态窗口标题和描述
            document.getElementById('label-selector-title').textContent = '选择误检标签';
            document.getElementById('label-selector-description').textContent = '请选择该检测框对应的误检标签（可多选）：';
            
            // 生成标签复选框
            const checkboxesDiv = document.getElementById('label-checkboxes');
            checkboxesDiv.innerHTML = '';
            
            Array.from(allLabels).sort().forEach(label => {
                const labelItem = document.createElement('label');
                labelItem.style.display = 'flex';
                labelItem.style.alignItems = 'center';
                labelItem.style.marginBottom = '8px';
                labelItem.style.cursor = 'pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = label;
                checkbox.checked = existingFalsePositiveLabels.includes(label);
                
                labelItem.appendChild(checkbox);
                labelItem.appendChild(document.createTextNode(` ${label}`));
                checkboxesDiv.appendChild(labelItem);
            });
            
            // 显示模态窗口
            document.getElementById('label-selector-modal').style.display = 'flex';
        }
        
        function closeLabelSelector() {
            document.getElementById('label-selector-modal').style.display = 'none';
            currentBboxForLabelSelection = null;
            currentBboxIndex = -1;
            currentStatusTypeForLabelSelection = null;
        }
        
        function confirmLabelSelection() {
            // 获取选中的标签（所有选中的标签）
            const selectedLabels = Array.from(document.querySelectorAll('#label-checkboxes input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            const imgName = imageList[currentIndex];
            const pred = currentData.predictions[imgName];
            
            if (!pred.statuses) {
                pred.statuses = [];
            }
            
            // 根据触发方式处理：状态快捷键或检测框点击
            if (currentStatusTypeForLabelSelection) {
                // 状态快捷键触发：误检、漏检、低置信度
                const statusType = currentStatusTypeForLabelSelection;
                
                if (statusType === 'false_positive') {
                    pred.false_positive_labels = selectedLabels;
                    if (selectedLabels.length > 0) {
                        if (!pred.statuses.includes('false_positive')) {
                            pred.statuses.push('false_positive');
                        }
                    } else {
                        const index = pred.statuses.indexOf('false_positive');
                        if (index >= 0) pred.statuses.splice(index, 1);
                    }
                } else if (statusType === 'missed') {
                    pred.missed_labels = selectedLabels;
                    if (selectedLabels.length > 0) {
                        if (!pred.statuses.includes('missed')) {
                            pred.statuses.push('missed');
                        }
                    } else {
                        const index = pred.statuses.indexOf('missed');
                        if (index >= 0) pred.statuses.splice(index, 1);
                    }
                } else if (statusType === 'low_confidence') {
                    pred.low_confidence_labels = selectedLabels;
                    if (selectedLabels.length > 0) {
                        if (!pred.statuses.includes('low_confidence')) {
                            pred.statuses.push('low_confidence');
                        }
                    } else {
                        const index = pred.statuses.indexOf('low_confidence');
                        if (index >= 0) pred.statuses.splice(index, 1);
                    }
                }
            } else if (currentBboxForLabelSelection) {
                // 检测框点击触发：误检标签
                pred.false_positive_labels = selectedLabels;
                if (selectedLabels.length > 0) {
                    if (!pred.statuses.includes('false_positive')) {
                        pred.statuses.push('false_positive');
                    }
                } else {
                    const index = pred.statuses.indexOf('false_positive');
                    if (index >= 0) pred.statuses.splice(index, 1);
                }
            }
            
            // 向后兼容：更新旧的status字段
            pred.status = pred.statuses.length > 0 ? pred.statuses[0] : null;
            
            // 保存到服务器
            saveImageStatuses();
            
            // 关闭模态窗口
            closeLabelSelector();
            
            // 更新显示
            updateViewer();
        }
        
        // 点击模态窗口外部关闭
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('label-selector-modal');
            if (e.target === modal) {
                closeLabelSelector();
            }
        });
    </script>
</body>
</html>

